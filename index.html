<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kommissionierung</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f8; }
    header { position: sticky; top: 0; background: white; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); z-index: 2; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn {
      border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700;
      box-shadow: 0 2px 8px rgba(0,0,0,.08); background: #111; color: #fff;
      cursor: pointer;
    }
    .btn.secondary { background: #fff; color: #111; border: 1px solid #ddd; box-shadow: none; }
    .btn.danger { background: #b00020; color: #fff; border: 0; }
    main { padding: 12px; }
    .card { background: white; border-radius: 16px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); margin-bottom: 12px; }
    .title { font-size: 18px; font-weight: 800; }
    label { font-size: 12px; font-weight: 700; color: #444; display: block; margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 16px;
      background: #fff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    th { text-align: left; font-size: 12px; color: #555; background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { margin-left: auto; }
    .pill { background: #efefef; padding: 6px 10px; border-radius: 999px; font-weight: 800; }
    #debug { font-size: 12px; color: #666; }
    
    /* Holzart Autocomplete Dropdown */
    .autocomplete-container { position: relative; }
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      display: none;
    }
    .autocomplete-dropdown.show { display: block; }
    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .autocomplete-item:hover { background: #f6f7f8; }
    .autocomplete-item b { color: #111; }
  </style>
</head>

<body>
<header>
  <div class="row">
    <div class="title">Kommissionierung</div>
    <div class="right row">
      <span class="pill" id="kommiLabel">—</span>
      <button class="btn secondary" id="btnNewKommi" type="button">Neue Kommissionierung</button>
      <button class="btn secondary" id="btnExportCurrent" type="button">CSV (aktuell)</button>
      <button class="btn" id="btnExportAll" type="button">CSV (alles)</button>
    </div>
  </div>
  <div id="debug">JS lädt…</div>
</header>

<main>
  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div>
        <div style="font-weight:800;">Neue Zeile erfassen</div>
        <div style="color:#666; font-size:13px;">Scan → Text → Enter. Enter springt weiter.</div>
      </div>
      <div class="row">
        <label style="margin:0;">
          <span style="display:block; font-size:12px; font-weight:700; color:#444; margin-bottom:6px;">CSV Trennzeichen</span>
          <select id="delimiter">
            <option value=",">Komma (,)</option>
            <option value=";">Semikolon (;)</option>
            <option value="\t">Tab</option>
          </select>
        </label>
        <button class="btn" id="btnAddRow" type="button">Zeile hinzufügen</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div>
        <label for="laenge">Länge (m)</label>
        <input id="laenge" autocomplete="off" inputmode="decimal" placeholder="z.B. 4.5" />
      </div>
      <div>
        <label for="breite">Breite (mm)</label>
        <input id="breite" autocomplete="off" inputmode="numeric" placeholder="z.B. 120" />
      </div>
      <div>
        <label for="staerke">Stärke (mm)</label>
        <input id="staerke" autocomplete="off" inputmode="numeric" placeholder="z.B. 45" />
      </div>
      <div>
        <label for="paket">Paket</label>
        <input id="paket" autocomplete="off" placeholder="Scan/ID" />
      </div>
      <div class="autocomplete-container">
        <label for="holzart">Holzart</label>
        <input id="holzart" autocomplete="off" placeholder="z.B. Eiche oder EI" />
        <div id="holzart-dropdown" class="autocomplete-dropdown"></div>
      </div>
      <div>
        <label for="sortierung">Sortierung</label>
        <input id="sortierung" autocomplete="off" placeholder="z.B. AB" />
      </div>
      <div>
        <label for="holztyp">Holztyp</label>
        <input id="holztyp" list="holztyp-list" autocomplete="off" placeholder="SF, SH oder MF" />
        <datalist id="holztyp-list">
          <option value="SF">
          <option value="SH">
          <option value="MF">
        </datalist>
      </div>
      <div>
        <label>Produkt (auto)</label>
        <input id="produkt" class="mono" readonly />
        <div style="font-size:12px; color:#666; margin-top:6px;">Produkt = Holztyp - Holzart - Sortierung</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:800;">Erfasste Zeilen</div>
      <button class="btn danger secondary" id="btnClearCurrent" type="button">Aktuelle Kommissionierung leeren</button>
    </div>
    <div style="overflow:auto; margin-top:10px; max-height: 55vh;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Länge</th>
            <th>Breite</th>
            <th>Stärke</th>
            <th>Paket</th>
            <th>Holzart</th>
            <th>Sortierung</th>
            <th>Holztyp</th>
            <th>Produkt</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "kommissionierungen_v1";

  const el = (id) => document.getElementById(id);
  const debug = (msg) => { el("debug").textContent = msg; };

  // Holzarten-Datenbank
  const holzarten = {
    "AAH": "Ahorn amerik.", "AAR": "Riegelahorn Am.", "ABA": "Abachi", "ABU": "Abura",
    "AH": "Ahorn europ.", "AHK": "Kernahorn", "AHM": "Muschelahorn", "AHR": "Riegelahorn Euro",
    "AMA": "Amaranth", "AMB": "Amboina", "AMZ": "Amazakoue", "ANE": "Anegre",
    "ANG": "Angelim Amargosa", "ANT": "Antolia", "APF": "Apfel", "ASP": "Aspe",
    "BAL": "Balsa", "BAN": "Bangkirai", "BEL": "Beli", "BGK": "Buche Kern gedämpft",
    "BI": "Birke", "BIA": "Apfelbirke", "BIE": "Eisbirke", "BIR": "Birnbaum",
    "BIS": "Birke geschält", "BO": "Bongossi", "BPA": "Buche Palazzo", "BUB": "Bubinga",
    "BUG": "Buche ged.", "BUP": "Buche Pfeffer", "BUK": "Buche Kern", "BUU": "Buche ung.",
    "CEI": "Ceiba", "CH": "Cherry", "CHE": "Chenchen", "CHF": "Chicken Feed",
    "CI": "Citola", "CP": "C-Pine", "CU": "Cumaru", "DGG": "Douglasie Geräuchert",
    "DGL": "Douglasie", "DI": "Dibetou", "DIF": "Difou", "DOU": "DOU",
    "EB": "Ebenholz", "EBA": "Eichebalken", "EG": "Eiche gedämpft", "EI": "Eiche",
    "EIA": "Eiche Altholz", "EIB": "Eibe", "EIG": "Eiche geräuchert", "EIK": "Eiche Kupfer",
    "EIR": "Roteiche", "EIS": "Eiche Silver", "EIT": "Eiche Tischplatte", "EIW": "Weißeiche",
    "ELG": "Elsbeere ged.", "ELK": "Elsbeere Kern", "ELM": "Red Elm", "ELS": "Elsbeere",
    "ER": "Erle", "ERA": "Erable", "ERG": "Erle gedämpft", "ESG": "Esche geaugt",
    "ESH": "Esche hell", "ESN": "Esche natur", "EST": "Esche Tischplatte", "EUG": "Eukalyptus geräuch.",
    "EUK": "Eukalyptus", "FAB": "Fichte Altholz Boden", "FAG": "Fichte Altholz ged.", "FAM": "Fi. Altholz Mantel",
    "FAS": "Fi. Altholz Seiten", "FAU": "Fichte Altholz ung.", "FIA": "Fichte astig", "FIG": "Fichte ged.",
    "FIH": "Fichte heimisch", "FIN": "Fichte nord.", "FNG": "Fichte nord. ged", "GAR": "Garapa",
    "HEM": "Hemlock", "HIC": "Hickory", "IP": "Ipe", "ITA": "Itauba",
    "JAM": "Jarrah Maser", "JAR": "Jarrah", "JAT": "Jatoba", "JUM": "Jumbo Wood",
    "KAM": "Kambala / Iroko", "KAS": "Kastanie", "KE": "Kelo", "KI": "Kiefer",
    "KIR": "Kirsche europ.", "KMA": "Khaya-Mahagoni", "KO": "Koto", "LA": "Laubholz",
    "LI": "Linde", "LIM": "Limba", "LÄ": "Lärche", "LÄR": "Lärche geräuchert",
    "LÄS": "Lärche sibirisch", "MA": "Macore", "MAC": "Macassar", "MAD": "Mandioqueira",
    "MAH": "Mahagoni", "MAM": "Madrona Maser", "MAN": "Mansonia / Bete", "MAR": "Maroni",
    "MAS": "Massaranduba", "MEB": "Merbau", "MER": "Meranti", "MU": "Mutenge",
    "MUK": "Mukulungu", "MY": "Myrte", "NA": "Nadelholz", "NU": "Nussbaum europ.",
    "NUA": "Schwarznuss", "OKO": "Okoume", "OL": "Olive", "OR": "Oregon-Pine",
    "PA": "Pappel", "PAD": "Padouk", "PAL": "Palisander", "PEC": "Pecan Nuß",
    "PI": "Pinie", "PLA": "Platane", "PPI": "Pitch Pine", "RA": "Ramin",
    "RGE": "Robinie geräuchert", "RO": "Rosenholz", "ROG": "Robinie ged", "ROU": "Robine unged.",
    "RÜ": "Rüster", "RÜG": "Rüster ged.", "SA": "Sapeli-Mahagoni", "SAB": "Sapeli-Mahagoni bes.",
    "SAS": "Sassafras", "SAT": "Satin Nuß", "SEN": "Sen", "SI": "Sipo-Mahagoni",
    "SIB": "Sipo-Mahagoni bes.", "STI": "Sapeli Tischplatte", "SUC": "Sucupira", "TA": "Tanne",
    "TE": "Teak", "TEB": "Teak besäumt", "TH": "Thuja", "TIN": "Tineo",
    "TU": "Whitewood / Tulip", "VAH": "Vogelaugenahorn", "VAV": "Vavona", "VIO": "Violett",
    "WB": "Hainbuche", "WBS": "Hainbuche Silver", "WE": "Wenge", "WEB": "Wenge bes.",
    "WEW": "Wenge weiß ( Lathi )", "YAY": "Yaya", "ZE": "Zebrano", "ZEB": "Zebrano besäumt",
    "ZEC": "Zeder (Cedro)", "ZED": "Zeder", "ZEL": "Zeder Libanon", "ZEW": "Western Red Cedar",
    "ZI": "Zirbe", "ZIG": "Zirbe gedämpft", "ZIR": "Ziricote", "ZIT": "Zitrone", "ZW": "Zwetschge"
  };

  function nowIsoCompact() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { kommis: [], activeId: null };
      return JSON.parse(raw);
    } catch {
      return { kommis: [], activeId: null };
    }
  }

  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  function createNewKommi() {
    const id = `KOMM_${nowIsoCompact()}`;
    const kommi = { id, createdAt: new Date().toISOString(), rows: [] };
    state.kommis.unshift(kommi);
    state.activeId = id;
    saveState(state);
    renderAll();
  }

  function getActiveKommi() {
    return state.kommis.find(k => k.id === state.activeId);
  }

  // init state
  if (!state.kommis.length) {
    createNewKommi();
  } else if (!state.activeId) {
    state.activeId = state.kommis[0].id;
    saveState(state);
  }

  const inputs = [
    el("laenge"), el("breite"), el("staerke"), el("paket"),
    el("holzart"), el("sortierung"), el("holztyp")
  ];
  const produktEl = el("produkt");

  // Holzart Autocomplete
  const holzartInput = el("holzart");
  const holzartDropdown = el("holzart-dropdown");
  
  holzartInput.addEventListener("input", (e) => {
    // Automatisch in Großbuchstaben umwandeln
    const cursorPos = e.target.selectionStart;
    e.target.value = e.target.value.toUpperCase();
    e.target.setSelectionRange(cursorPos, cursorPos);
    
    const value = e.target.value.trim();
    if (value.length === 0) {
      holzartDropdown.classList.remove("show");
      computeProdukt();
      return;
    }

    // Suche nach passenden Holzarten
    const matches = [];
    for (const [abbr, name] of Object.entries(holzarten)) {
      if (abbr.includes(value) || name.toUpperCase().includes(value)) {
        matches.push({ abbr, name });
      }
    }

    if (matches.length === 0) {
      holzartDropdown.classList.remove("show");
      computeProdukt();
      return;
    }

    // Dropdown befüllen
    holzartDropdown.innerHTML = matches.slice(0, 10).map(m => 
      `<div class="autocomplete-item" data-abbr="${m.abbr}">
        <b>${m.abbr}</b> - ${m.name}
      </div>`
    ).join("");
    holzartDropdown.classList.add("show");
    computeProdukt();
  });

  // Enter/Tab: Prüfe auf exakte Übereinstimmung und ersetze durch Abkürzung
  holzartInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === "Tab") {
      const value = holzartInput.value.trim();
      
      // Prüfen ob exakte Übereinstimmung mit vollem Namen existiert
      for (const [abbr, name] of Object.entries(holzarten)) {
        if (name.toUpperCase() === value) {
          e.preventDefault();
          holzartInput.value = abbr;
          holzartDropdown.classList.remove("show");
          computeProdukt();
          
          // Bei Enter/Tab zum nächsten Feld springen
          const idx = inputs.indexOf(holzartInput);
          if (idx !== -1 && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }
          return;
        }
      }
      
      // Kein Match gefunden, Dropdown schließen
      holzartDropdown.classList.remove("show");
    }
  });

  // Auswahl aus Dropdown
  holzartDropdown.addEventListener("click", (e) => {
    const item = e.target.closest(".autocomplete-item");
    if (item) {
      const abbr = item.getAttribute("data-abbr");
      holzartInput.value = abbr;
      holzartDropdown.classList.remove("show");
      computeProdukt();
      holzartInput.focus();
    }
  });

  // Dropdown schließen bei Klick außerhalb
  document.addEventListener("click", (e) => {
    if (!holzartInput.contains(e.target) && !holzartDropdown.contains(e.target)) {
      holzartDropdown.classList.remove("show");
    }
  });

  function computeProdukt() {
    const holztyp = el("holztyp").value.trim();
    const holzart = el("holzart").value.trim();
    const sortierung = el("sortierung").value.trim();
    
    // Validierung für Holztyp
    const validTypes = ["SF", "SH", "MF"];
    if (holztyp && !validTypes.includes(holztyp.toUpperCase())) {
      el("holztyp").style.borderColor = "orange";
      el("holztyp").style.backgroundColor = "#fff3cd";
    } else {
      el("holztyp").style.borderColor = "";
      el("holztyp").style.backgroundColor = "";
    }
    
    const parts = [holztyp, holzart, sortierung].filter(Boolean);
    produktEl.value = parts.join("-");
    return produktEl.value;
  }

  ["holztyp","holzart","sortierung"].forEach(id => {
    el(id).addEventListener("input", computeProdukt);
  });

  // Sortierung und Holztyp immer in Großbuchstaben umwandeln
  ["sortierung", "holztyp"].forEach(id => {
    el(id).addEventListener("input", (e) => {
      const cursorPos = e.target.selectionStart;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(cursorPos, cursorPos);
    });
  });

  // Enter/Tab springt weiter, bei Breite wird direkt hinzugefügt
  inputs.forEach((input, idx) => {
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === "Tab") {
        e.preventDefault();
        // Wenn wir bei Breite (Index 1) sind, direkt Zeile hinzufügen
        if (idx === 1) {
          addRow();
        } else if (idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        } else {
          el("btnAddRow").focus();
        }
      }
    });
  });

  // F8: Letzte Zeile löschen
  document.addEventListener("keydown", (e) => {
    if (e.key === "F8") {
      e.preventDefault();
      const kommi = getActiveKommi();
      if (kommi && kommi.rows.length > 0) {
        kommi.rows.pop();
        saveState(state);
        renderTable();
      }
    }
  });

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderAll() {
    const kommi = getActiveKommi();
    el("kommiLabel").textContent = kommi ? kommi.id : "—";
    renderTable();
  }

  function renderTable() {
    const kommi = getActiveKommi();
    const tb = el("tbody");
    tb.innerHTML = "";
    if (!kommi) return;

    kommi.rows.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(r.laenge)}</td>
        <td>${escapeHtml(r.breite)}</td>
        <td>${escapeHtml(r.staerke)}</td>
        <td class="mono">${escapeHtml(r.paket)}</td>
        <td>${escapeHtml(r.holzart)}</td>
        <td>${escapeHtml(r.sortierung)}</td>
        <td>${escapeHtml(r.holztyp)}</td>
        <td class="mono">${escapeHtml(r.produkt)}</td>
        <td><button class="btn secondary" type="button" data-del="${i}">Löschen</button></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-del"));
        const kommi = getActiveKommi();
        kommi.rows.splice(idx, 1);
        saveState(state);
        renderTable();
      });
    });
  }

  function clearInputs() {
    // Nur Länge und Breite leeren, Rest bleibt stehen
    el("laenge").value = "";
    el("breite").value = "";
    el("laenge").focus();
  }

  function addRow() {
    const kommi = getActiveKommi();
    if (!kommi) return;

    const row = {
      laenge: el("laenge").value.trim(),
      breite: el("breite").value.trim(),
      staerke: el("staerke").value.trim(),
      paket: el("paket").value.trim(),
      holzart: el("holzart").value.trim(),
      sortierung: el("sortierung").value.trim(),
      holztyp: el("holztyp").value.trim(),
      produkt: computeProdukt()
    };

    if (!row.paket) { alert("Bitte Paket eingeben/scanen."); el("paket").focus(); return; }
    if (!row.produkt) { alert("Produkt ist leer. Bitte Holztyp/Holzart/Sortierung prüfen."); el("holztyp").focus(); return; }

    kommi.rows.push(row);
    saveState(state);
    renderTable();
    clearInputs();
  }

  // CSV
  function csvEscape(value, delimiter) {
    const s = String(value ?? "");
    const needsQuotes = s.includes('"') || s.includes("\n") || s.includes("\r") || s.includes(delimiter);
    const escaped = s.replaceAll('"', '""');
    return needsQuotes ? `"${escaped}"` : escaped;
  }

  function buildCsv(rows, delimiter) {
    const header = ["lot_length","width","thickness","lot_name","Holzart","Sortierung","product_id"];
    const lines = [];
    lines.push(header.map(h => csvEscape(h, delimiter)).join(delimiter));
    for (const r of rows) {
      lines.push([r.laenge,r.breite,r.staerke,r.paket,r.holzart,r.sortierung,r.produkt]
        .map(v => csvEscape(v, delimiter)).join(delimiter));
    }
    return lines.join("\r\n");
  }

  function downloadText(filename, text) {
    const bom = "\uFEFF";
    const blob = new Blob([bom + text], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---- BUTTON WIRING (das war bei dir vermutlich das Problem) ----
  el("btnAddRow").addEventListener("click", () => { debug("Zeile hinzugefügt."); addRow(); });
  el("btnNewKommi").addEventListener("click", () => { debug("Neue Kommissionierung."); createNewKommi(); clearInputs(); });

  el("btnClearCurrent").addEventListener("click", () => {
    const kommi = getActiveKommi();
    if (!kommi) return;
    if (!confirm("Aktuelle Kommissionierung wirklich leeren?")) return;
    kommi.rows = [];
    saveState(state);
    renderTable();
    clearInputs();
    debug("Aktuelle Kommissionierung geleert.");
  });

  el("btnExportCurrent").addEventListener("click", () => {
    const kommi = getActiveKommi();
    if (!kommi) return;
    const d = el("delimiter").value === "\\t" ? "\t" : el("delimiter").value;
    downloadText(`${kommi.id}.csv`, buildCsv(kommi.rows, d));
    debug("CSV (aktuell) exportiert.");
  });

  el("btnExportAll").addEventListener("click", () => {
    const d = el("delimiter").value === "\\t" ? "\t" : el("delimiter").value;
    const header = ["Kommissionierung","Länge","Breite","Stärke","Paket","Holzart","Sortierung","Holztyp","Produkt"];
    const lines = [header.map(h => csvEscape(h, d)).join(d)];
    for (const k of state.kommis.slice().reverse()) {
      for (const r of k.rows) {
        lines.push([k.id,r.laenge,r.breite,r.staerke,r.paket,r.holzart,r.sortierung,r.holztyp,r.produkt]
          .map(v => csvEscape(v, d)).join(d));
      }
    }
    downloadText(`ALLE_KOMMISSIONIERUNGEN_${nowIsoCompact()}.csv`, lines.join("\r\n"));
    debug("CSV (alles) exportiert.");
  });

  // Start
  renderAll();
  clearInputs();
  debug("JS bereit ✅ Buttons sollten funktionieren.");
});
</script>
</body>
</html>